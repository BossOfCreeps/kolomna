{% extends "base.html" %}
{% load prettifiers %}

{% block title %}
    –ö–æ—Ä–∑–∏–Ω–∞
{% endblock %}

{% block content %}
    <div class="container basket">
        <h1 class="text-center mt-5">–ö–æ—Ä–∑–∏–Ω–∞</h1>
        <form class="form" method="post" action="{% url "tickets:basket-buy" %}">
            {% csrf_token %}
            {% for date, event_schedule_dict in data.items %}
                <p class="blue-div mt-5">{% date_to_str_tag date %}</p>
                {% for event_schedule, basket_events in event_schedule_dict.items %}
                    <div class="row basket">
                        <div class="col-sm-1 text-center">
                            <p>{{ event_schedule.start_at|date:"H:i" }}</p>
                            <p>{{ event_schedule.end_at|date:"H:i" }}</p>
                        </div>
                        <div class="col-sm-6">
                            <p>
                                <a href="{% url 'events:event-detail' event_schedule.event.id %}">{{ event_schedule.event.name }}</a>
                            </p>
                            <p><small>{{ event_schedule.event.organization.name }}</small></p>
                        </div>
                        <div class="col-sm-3">
                            {% for basket_event in basket_events %}
                                <p {% if basket_event.id in more_then_total_count %}class="bg-danger"{% endif %}>
                                    {{ basket_event.count }}
                                    {% category_to_str_tag basket_event.event_price.category %}
                                    {% if basket_event.set_id %}
                                        <span>
                                            ("–ù–∞–±–æ—Ä ‚Ññ{% set_by_uuid basket_event.set_id %}")
                                        </span>
                                    {% else %}
                                        <span>
                                            ({{ basket_event.event_price.price }}‚ÇΩ)
                                        </span>
                                    {% endif %}
                                </p>
                            {% endfor %}
                        </div>
                        <div class="col-sm-1 text-center">
                            <p>
                                {% count_price basket_events %} ‚ÇΩ
                            </p>
                        </div>
                        <div class="col-sm-1 text-center">
                            <a href="#" hidden>
                                <i class="fa-solid fa-pen"></i>
                            </a>
                            <p>
                                {% if basket_events|has_single_event %}
                                    <a href="{% url 'tickets:event-delete' event_schedule.id %}">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}

            {% if sets %}
                <p class="blue-div mt-5">–ù–∞–±–æ—Ä—ã</p>
                {% for set in sets %}
                    <div class="row basket">
                        <div class="col-sm-1">
                            <p>‚Ññ{{ set.id }}</p>
                        </div>
                        <div class="col-sm-9">
                            <p><a href="{% url 'events:event_set-detail' set.id %}">{{ set.name }}</a></p>
                        </div>
                        <div class="col-sm-1 text-center">
                            <p>
                                {{ set.price }} ‚ÇΩ
                            </p>
                        </div>
                        <div class="col-sm-1 text-center">
                            <p>
                                <a href="{% url 'events:event_set-del_from_basket' set.set_id %}">
                                    <i class="fa-solid fa-trash"></i>
                                </a>
                            </p>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            {% if more_then_total_count %}
                <p class="red_text mt-5">
                    –í—ã –≤—ã–±—Ä–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–µ—Å—Ç. –ö—Ä–∞—Å–Ω—ã–º —É–∫–∞–∑–∞–Ω—ã –±–∏–ª–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å.
                </p>
            {% endif %}

            {% if data and not more_then_total_count %}
                <div class="basket-buy-block mt-5">
                    {% if request.user.is_tic_employee %}
                        <div class="input-group mb-3">
                            <span class="input-group-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–æ–º—É —Å–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç—ã</span>
                            <select class="form-control selectpicker" data-live-search="true" name="user">
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                    {% if has_collisions %}
                        <p class="red_text mt-5">
                            –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —É—Å–ø–µ–µ—Ç–µ –¥–æ–±–µ–∂–∞—Ç—å? üëÄ<br>
                            –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–∞–ª–µ–∫–æ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ –∏ –ª—É—á—à–µ –∑–∞–ª–æ–∂–∏—Ç—å 30-45 –º–∏–Ω—É—Ç –Ω–∞
                            –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                        </p>
                        <p class="btn btn-danger mb-5" onclick="enableForm()">
                            –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –±–µ—Ä—É –Ω–∞ —Å–µ–±—è –≤—Å–µ —Ä–∏—Å–∫–∏ –∑–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –æ–ø–æ–∑–¥–∞–Ω–∏–µ
                        </p>
                    {% endif %}
                    <p>
                        –ò—Ç–æ–≥–æ: {{ total_price }} ‚ÇΩ
                    </p>
                    <p>
                        <input type="submit" class="btn full-blue-btn" value="–ö—É–ø–∏—Ç—å" id="basket_buy_button"
                               {% if has_collisions %}disabled{% endif %}>
                    </p>
                </div>
            {% endif %}
            {% if not data %}
                –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è
            {% endif %}
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        $('select').selectpicker();
    </script>

    <script>
        function enableForm() {
            document.getElementById("basket_buy_button").disabled = false;
        }
    </script>
{% endblock %}