{% extends "base.html" %}

{% block content %}
    <div id="calendar-event-info">
        <button type="button" class="btn-close" aria-label="Close" onclick="closeEventInfo()"></button>

        <h3 id="calendar-event-info-name" class="ms-3 me-3 mt-3 mb-4">
            Экскурсия в музей истории со вкусом «Коломенская пастила»
        </h3>
        <div class="row ms-1 me-1 mb-3">
            <div class="col">
                <p class="mb-4">
                    <i class="fa-regular fa-calendar"></i> <span id="calendar-event-info-date"></span>
                </p>
                <p class="mb-4">
                    <i class="fa-solid fa-people-group"></i> <span id="calendar-event-info-visitors"></span> ост
                </p>
                <p class="mb-4">
                    <i class="fa-regular fa-clock"></i> <span id="calendar-event-info-duration"></span> часа
                </p>
            </div>
            <div class="col">
                <div>
                    <p class="mb-1">
                        <span id="calendar-event-info-purchase_standard"></span> стандартных
                        (<span id="calendar-event-info-price_standard"></span> ₽)
                    </p>
                    <p class="mb-1">
                        <span id="calendar-event-info-purchase_child"></span> детских
                        (<span id="calendar-event-info-price_child"></span> ₽)
                    </p>
                    <p class="mb-1">
                        <span id="calendar-event-info-purchase_student"></span> студенческих
                        (<span id="calendar-event-info-price_student"></span> ₽)
                    </p>
                    <p class="mb-1">
                        <span id="calendar-event-info-purchase_retiree"></span> пенсионных
                        (<span id="calendar-event-info-price_retiree"></span> ₽)
                    </p>
                </div>
                <div class="mt-3">
                    <a href="#"><i class="fa-solid fa-pen me-3"></i></a>
                    <a href="#"><i class="fa-solid fa-trash me-3"></i></a>
                </div>
            </div>
        </div>
    </div>
    <div id='calendar'></div>
{% endblock %}

{% block scripts %}
    <script>
        let event_block_viewed = false;

        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                locale: 'ru-ru',
                themeSystem: 'bootstrap5',
                datesAboveResources: true,
                buttonText: {today: "Сегодня", month: "Месяц", week: "Неделя", day: "День"},
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridDay,resourceTimeGridWeek'
                },
                views: {resourceTimeGridWeek: {type: 'resourceTimeGrid', duration: {days: 7}, buttonText: 'Неделя'}},
                initialView: 'resourceTimeGridDay',
                resources: [
                    {% for organization in organizations %}
                        {id: '{{ organization.pk }}', title: '{{ organization.name }}'},
                    {% endfor %}
                ],
                events: [
                    {% for event_schedule in event_schedules %}
                        {
                            id: '{{ event_schedule.pk  }}',
                            title: '{{ event_schedule.event.name }}\nОсталось: {{ event_schedule.lefts_visitors_sum }}',
                            resourceId: '{{ event_schedule.event.organization.pk }}',
                            start: '{{ event_schedule.start_at|date:"c" }}',
                            end: '{{ event_schedule.end_at|date:"c"  }}',
                            // extra
                            event_name: '{{ event_schedule.event.name  }}',
                            event_date: '{{ event_schedule.start_at_as_str  }}',
                            event_lefts_visitors_sum: {{ event_schedule.lefts_visitors_sum  }},
                            event_max_visitors: {{ event_schedule.event.max_visitors  }},
                            event_duration: '{{ event_schedule.event.duration_as_str  }}',
                            {% for k,v in event_schedule.prices_info.items %}
                                event_{{ k }}: '{{ v }}',
                            {% endfor %}
                        },
                    {% endfor %}
                ],
                eventClick: function (info) {
                    // https://fullcalendar.io/docs/eventClick-demo
                    const eventObj = info.event;

                    let div = document.getElementById('calendar-event-info');
                    div.style.display = 'block';
                    div.style.position = 'absolute';
                    div.style.top = info.jsEvent.pageY + "px";
                    div.style.left = info.jsEvent.pageX + "px";

                    const extendedProps = eventObj.extendedProps;
                    console.log(extendedProps);

                    document.getElementById('calendar-event-info-name').innerHTML = extendedProps.event_name;
                    document.getElementById('calendar-event-info-date').innerHTML = extendedProps.event_date;
                    document.getElementById('calendar-event-info-visitors').innerHTML = extendedProps.event_lefts_visitors_sum + "/" + extendedProps.event_max_visitors;
                    document.getElementById('calendar-event-info-duration').innerHTML = extendedProps.event_duration;

                    document.getElementById('calendar-event-info-purchase_standard').innerHTML = extendedProps.event_purchase_standard;
                    document.getElementById('calendar-event-info-purchase_child').innerHTML = extendedProps.event_purchase_child;
                    document.getElementById('calendar-event-info-purchase_student').innerHTML = extendedProps.event_purchase_student;
                    document.getElementById('calendar-event-info-purchase_retiree').innerHTML = extendedProps.event_purchase_retiree;

                    document.getElementById('calendar-event-info-price_standard').innerHTML = extendedProps.event_price_standard;
                    document.getElementById('calendar-event-info-price_child').innerHTML = extendedProps.event_price_child;
                    document.getElementById('calendar-event-info-price_student').innerHTML = extendedProps.event_price_student;
                    document.getElementById('calendar-event-info-price_retiree').innerHTML = extendedProps.event_price_retiree;


                    sleep(100).then(() => {
                        event_block_viewed = true;
                    });
                },
            });
            calendar.render();
        });


        function closeEventInfo() {
            document.getElementById('calendar-event-info').style.display = 'none';
            event_block_viewed = false;
        }

        window.addEventListener('click', function (e) {
            if (event_block_viewed && !document.getElementById('calendar-event-info').contains(e.target)) {
                closeEventInfo();
            }
        });

    </script>
{% endblock %}