{% extends "base.html" %}

{% block content %}
    <div id="calendar-event-info">
        <button type="button" class="btn-close" aria-label="Close" onclick="closeEventInfo()"></button>

        <h3 id="calendar-event-info-title" class="ms-3 me-3 mt-3 mb-4">
            Экскурсия в музей истории со вкусом «Коломенская пастила»
        </h3>
        <div class="row ms-1 me-1 mb-3">
            <div class="col">
                <p class="mb-4">
                    <i class="fa-regular fa-calendar"></i> 31 мая, 2022
                </p>
                <p class="mb-4">
                    <i class="fa-solid fa-people-group"></i> 3312 человек
                </p>
                <p class="mb-4">
                    <i class="fa-regular fa-clock"></i> 2 часа
                </p>
            </div>
            <div class="col">
                <div>
                    <p class="mb-1">
                        10 стандартных (500 ₽)
                    </p>
                    <p class="mb-1">
                        10 детских (500 ₽)
                    </p>
                    <p class="mb-1">
                        10 студенческих (500 ₽)
                    </p>
                    <p class="mb-1">
                        10 пенсионных (500 ₽)
                    </p>
                </div>
                <div class="mt-3">
                    <a href="#"><i class="fa-solid fa-pen me-3"></i></a>
                    <a href="#"><i class="fa-solid fa-trash me-3"></i></a>
                </div>
            </div>
        </div>
    </div>
    <div id='calendar'></div>
{% endblock %}

{% block scripts %}
    <script>
        let event_block_viewed = false;

        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                locale: 'ru-ru',
                themeSystem: 'bootstrap5',
                datesAboveResources: true,
                buttonText: {today: "Сегодня", month: "Месяц", week: "Неделя", day: "День"},
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridDay,resourceTimeGridWeek'
                },
                views: {resourceTimeGridWeek: {type: 'resourceTimeGrid', duration: {days: 7}, buttonText: 'Неделя'}},
                initialView: 'resourceTimeGridDay',
                resources: [
                    {% for organization in organizations %}
                        {id: '{{ organization.pk }}', title: '{{ organization.name }}'},
                    {% endfor %}
                ],
                events: [
                    {% for event_schedule in event_schedules %}
                        {
                            id: '{{ event_schedule.pk  }}',
                            title: '{{ event_schedule.event.name }}\n1',
                            resourceId: '{{ event_schedule.event.organization.pk }}',
                            start: '{{ event_schedule.start_at|date:"c" }}',
                        },
                    {% endfor %}
                ],
                eventClick: function (info) {
                    // https://fullcalendar.io/docs/eventClick-demo
                    const eventObj = info.event;

                    let div = document.getElementById('calendar-event-info');
                    div.style.display = 'block';
                    div.style.position = 'absolute';
                    div.style.top = info.jsEvent.pageY + "px";
                    div.style.left = info.jsEvent.pageX + "px";

                    console.log(info.jsEvent);

                    sleep(100).then(() => {
                        event_block_viewed = true;
                    });
                },
            });
            calendar.render();
        });


        function closeEventInfo() {
            document.getElementById('calendar-event-info').style.display = 'none';
            event_block_viewed = false;
        }

        window.addEventListener('click', function (e) {
            if (event_block_viewed && !document.getElementById('calendar-event-info').contains(e.target)) {
                closeEventInfo();
            }
        });

    </script>
{% endblock %}